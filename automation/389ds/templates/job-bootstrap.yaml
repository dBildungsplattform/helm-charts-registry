{{- if .Values.extendedBootstrap.enabled -}}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "389ds.fullname" . }}-bootstrap
  labels:
    {{- include "389ds.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": {{ .Values.extendedBootstrap.helmHook | quote }}
spec:
  template:
    spec:
      containers:
      - name: dirsrv-bootstrap
        image: "{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        securityContext:
          readOnlyRootFilesystem: true
        volumeMounts:
        - name: bootstrap-scripts
          mountPath: /scripts
        command: ["/scripts/bootstrap.sh"]
        env:
        - name: DS_DM_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ .Values.dsDmPassword.secretName | quote }}
              key: {{ .Values.dsDmPassword.secretKey | quote }}
        - name: DS_SUFFIX_NAME
          value: {{ .Values.dsSuffixName | quote }}
        - name: BOOTSTRAP_HA_PEER_HOSTS
          value: {{ .Values.extendedBootstrap.peers | quote}}
        - name: BOOTSTRAP_BACKEND_NAME
          value: {{ .Values.extendedBootstrap.backendName | quote }}
        - name: BOOTSTRAP_RM_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ .Values.extendedBootstrap.rmPassword.secretName | quote }}
              key: {{ .Values.extendedBootstrap.rmPassword.secretKey | quote }}
      volumes:
        - name: bootstrap-scripts
          configMap:
            name: {{ include "389ds.fullname" . }}-bootstrap
            defaultMode: 0555
      restartPolicy: OnFailure
  backoffLimit: 4
{{ end }}
